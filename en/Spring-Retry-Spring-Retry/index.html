<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-164526897-1"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-164526897-1');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?49e5faf2bfd6c26c1eb20bad10ef10c7";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="Java,v-vincen,v-vincen,livemylife,IT  blog,Blog"/>
  <link rel="shortcut icon" href="/img/avatar/favicon.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/highlight.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/widget.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/rocket.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/signature.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/catalog.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/css/gitalk.css"/>
      <!-- gitalk end -->
    

  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://v-vincen.life/en/Spring-Retry-Spring-Retry/">
  <title>
    
      [Spring Retry] Spring Retry - JavaDev | 一如Java深似海
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--light">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'light';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'hexo-theme-livemylife/blog'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- 
		<a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>

		 -->

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Live My Life</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <!-- CDN: jsdelivr start -->
  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/img/springretry/springretry_bg.png');
      --intro-header-background-image-url-page: url('https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io//img/springretry/springretry_bg.png');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/img/springretry/springretry_bg.png');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io//img/springretry/springretry_bg.png');
    }
    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/img/springretry/springretry_bg.png'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/vincent-white.png');
      }
    
  </style>
  <!-- CDN: jsdelivr end -->





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#Spring Retry" title="Spring Retry">Spring Retry</a>
              
            </div>
            <h1>[Spring Retry] Spring Retry</h1>
            <h2 class="subheading">Spring Retry provides an ability to automatically re-invoke a failed operation.</h2>
            <span class="meta">
              Posted by Mr.Vincent on
              2020-04-30
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">16</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">3.8k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <p>日常开发中经常遇到调用外部接口失败的情况，这时候我们需要去设置失败重试机制。正常情况我们的重试机制是：如果出错了，一般是网络抖动或者延迟的情况，设置重试一次，或者几次。方案如下：</p>
<p><code>try-catch-redo</code> 简单重试模式：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    doSomething();</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    redo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果想定制什么时候重试，重试几次，就需要我们自己定义重试策略，那么我们的代码就稍微复杂一些，可能是如下方案：</p>
<p><code>try-catch-redo-retry strategy</code> 策略重试模式：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    doSomething();</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    redo(retryTime,interval);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如上是我们一般的处理方案，由上我们大致可以看出如果想要实现一个优雅的重试方案，需要我们详细的去考虑重试机制，重试策略，重试失败措施，重试代码如何做到不侵入业务代码等等。所以，这样的一个小功能我们也是可以做成很有意思的小组件的。现代分布式系统中系统调用如此频繁，重试机制也是大家开发中的重复性劳动，所以这种不必要的代码已经有人给我们写好了，分别是 Java 中的 <code>Spring-Retry</code> 和 <code>Guava-Retrying</code>。</p>
<p>其中 <code>Spring-Retry</code> 是基于 <code>Throwable</code> 类型的重试机制，即针对可捕获异常执行重试策略，并提供相应的回滚策略；而 <code>Guava-Retrying</code> 提供了更为丰富的重试源定义，譬如多个异常或者多个返回值。那我们就先来学习下 <code>Spring-Retry</code>。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>官方定义：</strong></p>
<blockquote>
<p>This project provides declarative retry support for Spring applications. It is used in Spring Batch, Spring Integration, and others. Imperative retry is also supported for explicit usage.</p>
</blockquote>
<h2 id="类结构说明"><a href="#类结构说明" class="headerlink" title="类结构说明"></a>类结构说明</h2><p><img src="1.jpg" alt="1"></p>
<p>概览</p>
<ul>
<li><code>RetryCallback</code>：封装你需要重试的业务逻辑（上文中的 doSth）；</li>
<li><code>RecoverCallback</code>：封装在多次重试都失败后你需要执行的业务逻辑（上文中的 doSthWhenStillFail）</li>
<li><code>RetryContext</code>：重试语境下的上下文，可用于在多次 <code>Retry</code> 或者 <code>Retry 和 Recover 之间</code>传递参数或状态（在多次 <code>doSth</code> 或者 <code>doSth 与 doSthWhenStillFail 之间</code>传递参数）；</li>
<li><code>RetryOperations</code>：定义了“重试”的基本框架（模板），要求传入 <code>RetryCallback</code>，可选传入 <code>RecoveryCallback</code>；</li>
<li><code>RetryListener</code>：典型的“监听者”，在重试的不同阶段通知“监听者”（例如 doSth，wait 等阶段时通知）；</li>
<li><code>RetryPolicy</code>：重试的策略或条件，可以简单的进行多次重试，可以是指定超时时间进行重试（上文中的 someCondition）；</li>
<li><code>BackOffPolicy</code>：重试的回退策略，在业务逻辑执行发生异常时。如果需要重试，我们可能需要等一段时间（可能服务器过于繁忙，如果一直不间隔重试可能拖垮服务器）， 当然这段时间可以是 0，也可以是固定的，可以是随机的（参见 tcp 的拥塞控制算法中的回退策略）。回退策略在上文中体现为 wait()；</li>
<li><code>RetryTemplate</code>：<code>RetryOperations</code> 的具体实现，组合了 <code>RetryListener[]，BackOffPolicy，RetryPolicy</code>。</li>
</ul>
<h2 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h2><h3 id="RetryOperations-接口"><a href="#RetryOperations-接口" class="headerlink" title="RetryOperations 接口"></a><code>RetryOperations</code> 接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RetryOperations</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(RetryCallback&lt;T&gt; retryCallback)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(RetryCallback&lt;T&gt; retryCallback, RecoveryCallback&lt;T&gt; recoveryCallback)</span></span></span><br><span class="line">        <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(RetryCallback&lt;T&gt; retryCallback, RetryState retryState)</span></span></span><br><span class="line">        <span class="keyword">throws</span> Exception, ExhaustedRetryException;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(RetryCallback&lt;T&gt; retryCallback, RecoveryCallback&lt;T&gt; recoveryCallback,</span></span></span><br><span class="line">        RetryState retryState) <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RetryCallback-接口"><a href="#RetryCallback-接口" class="headerlink" title="RetryCallback 接口"></a><code>RetryCallback</code> 接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RetryCallback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">doWithRetry</span><span class="params">(RetryContext context)</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回调被执行，如果它失败（通过抛出异常），它将被重试，直到它成功，或者实现决定中止。在 <code>RetryOperations</code> 接口中有许多重载的执行方法，当所有的重试尝试都结束时，它们处理各种用于恢复的用例，以及重试状态（允许客户机和实现在调用之间存储信息）。</p>
<h3 id="重试策略"><a href="#重试策略" class="headerlink" title="重试策略"></a>重试策略</h3><p><strong><code>RetryPolicy</code> 接口</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RetryPolicy</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// canRetry 在每次重试的时候调用，是否可以继续重试的判断条件</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">canRetry</span><span class="params">(RetryContext context)</span></span>; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// open 重试开始前调用，会创建一个重试上下文到 RetryContext，保存重试的堆栈等信息 registerThrowable 每次重试异常时调用（有异常会继续重试）；</span></span><br><span class="line">    <span class="comment">// 例：SimpleRetryPolicy 当重试次数达到3（默认3次）停止重试，重试次数保存在重试上下文中。</span></span><br><span class="line">    <span class="function">RetryContext <span class="title">open</span><span class="params">(RetryContext parent)</span></span>; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(RetryContext context)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerThrowable</span><span class="params">(RetryContext context, Throwable throwable)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>常见策略</strong></p>
<ul>
<li><p><code>NeverRetryPolicy</code>：只允许调用 <code>RetryCallback</code> 一次，不允许重试。</p>
</li>
<li><p><code>AlwaysRetryPolicy</code>：允许无限重试，直到成功，此方式逻辑不当会导致死循环。</p>
</li>
<li><p><code>SimpleRetryPolicy</code>：固定次数重试策略，默认重试最大次数为3次，<code>RetryTemplate</code> 默认使用的策略。</p>
<p>  <strong>eg：</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SimpleRetryPolicy simpleRetryPolicy = <span class="keyword">new</span> SimpleRetryPolicy();</span><br><span class="line">simpleRetryPolicy.setMaxAttempts(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>TimeoutRetryPolicy</code>：可以实现指定时间内的重试。超时时间通过参数 timeout 进行设置。</p>
<p>  <strong>eg：</strong> 默认超时时间1s，使用方式如下</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// all spend 1s</span></span><br><span class="line">TimeoutRetryPolicy timeoutRetryPolicy = <span class="keyword">new</span> TimeoutRetryPolicy(); </span><br><span class="line">timeoutRetryPolicy.setTimeout(<span class="number">2000L</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ExceptionClassifierRetryPolicy</code>：设置不同异常的重试策略，类似组合重试策略，区别在于这里只区分不同异常的重试。</p>
<p>  <strong>eg：</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ExceptionClassifierRetryPolicy retryPolicy = <span class="keyword">new</span> ExceptionClassifierRetryPolicy();</span><br><span class="line">Map&lt;Class&lt;? extends Throwable&gt;, RetryPolicy&gt; policyMap = Maps.newHashMap();</span><br><span class="line"></span><br><span class="line">policyMap.put(NullPointerException.class, <span class="keyword">new</span> SimpleRetryPolicy());</span><br><span class="line">policyMap.put(ArithmeticException.class, <span class="keyword">new</span> TimeoutRetryPolicy());</span><br><span class="line"></span><br><span class="line">retryPolicy.setPolicyMap(policyMap);</span><br></pre></td></tr></table></figure>
<p>  上述示例中，我们针对重试业务抛出的空指针异常使用 <code>SimpleRetryPolicy</code> 策略，而对于算术异常采用 <code>TimeoutRetryPolicy</code> 策略。实际的重试过程中，这两中情况有可能交替出现，但不管如何，只要有一个重试策略达到终止状态，则整个重试调用终止。</p>
</li>
<li><p><code>CircuitBreakerRetryPolicy</code>：有熔断功能的重试策略，需设置3个参数 <code>openTimeout</code>、<code>resetTimeout</code> 和 <code>delegate</code>。</p>
</li>
<li><p><code>CompositeRetryPolicy</code>：实现了重试策略的组合。通过其 <code>policies</code> 字段，可以为其添加多个重试策略。组合策略执行的过程中，所有策略只要有一个达成终止条件，那么该重试结束。我们可以用组合重试策略实现一些相对比较复杂的重试。</p>
<p>  <strong>eg：</strong> 比如我们要实现在指定时间1s内重试3次，每次重试间隔0.2秒，就可以使用以下方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CompositeRetryPolicy compositeRetryPolicy = <span class="keyword">new</span> CompositeRetryPolicy();</span><br><span class="line"></span><br><span class="line">SimpleRetryPolicy simpleRetryPolicy = <span class="keyword">new</span> SimpleRetryPolicy();</span><br><span class="line"></span><br><span class="line">TimeoutRetryPolicy timeoutRetryPolicy = <span class="keyword">new</span> TimeoutRetryPolicy();</span><br><span class="line"></span><br><span class="line">FixedBackOffPolicy fixedBackOffPolicy = <span class="keyword">new</span> FixedBackOffPolicy();</span><br><span class="line">fixedBackOffPolicy.setBackOffPeriod(<span class="number">200</span>); <span class="comment">// 每次重试间隔200ms</span></span><br><span class="line"></span><br><span class="line">compositeRetryPolicy.setPolicies(<span class="keyword">new</span> RetryPolicy[]&#123; </span><br><span class="line">		simpleRetryPolicy,</span><br><span class="line">		timeoutRetryPolicy,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="重试回退策略"><a href="#重试回退策略" class="headerlink" title="重试回退策略"></a>重试回退策略</h3><p>重试策略 <code>RetryPolicy</code> 只是实现了基本的重试功能，也就是核心的循环逻辑，形如以下的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> ... <span class="keyword">while</span></span><br></pre></td></tr></table></figure></p>
<p>那么每次重试之间的相关场景该如何处理呢？为此，<code>Spring Retry</code> 将重试间可能有的重试等待策略抽像成了 <code>BackoffPolicy</code> 接口，并提供了一些简单的实现。默认情况下是立即重试，如果需要配置等待一段时间后重试则需要指定回退策略 <code>BackoffRetryPolicy</code>。在使用 <code>RetryTemplate</code> 时，可以通过 <code>setBackOffPolicy</code> 方法进行设置。</p>
<ul>
<li><p><code>NoBackOffPolicy</code>：无回退算法策略，每次重试时立即重试。</p>
</li>
<li><p><code>FixedBackOffPolicy</code>：应该是最常用的重试间隔策略。有两个基本属性：<code>backOffPeriod</code>（设定间隔时间）和 <code>sleeper</code>（等待策略）。<code>sleeper</code> 默认是 <code>Thread.sleep</code> — 即线程休眠，<code>backOffPeriod</code> 指定休眠时间，默认1秒。</p>
<p>   <strong>eg:</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FixedBackOffPolicy fixedBackOffPolicy = <span class="keyword">new</span> FixedBackOffPolicy();</span><br><span class="line">fixedBackOffPolicy.setBackOffPeriod(<span class="number">1500</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>UniformRandomBackOffPolicy</code>：允许给定最大，最小等待时间，然后让每次的重试在其之间进行随机等待。参数 <code>minBackOffPeriod</code> 和 <code>maxBackOffPeriod</code> 的默认值分别为500ms和1500ms，具体的计算方式是：</p>
</li>
<li><p><code>ExponentialBackOffPolicy</code>：类提供了指数级重试间隔的实现。通过该类，可以使重试之间的等待按指数级增长。其中：</p>
<ul>
<li><code>initialInterval</code> 属性为初始默认间隔，默认值是100毫秒；</li>
<li><code>maxInterval</code> 属性为最大默认间隔。当实际计算出的间隔超过该值时，使用该值。默认为30秒；</li>
<li><code>multiplier</code> 为乘数。默认2，当其等于1时，其行为同 <code>FixedBackOffPolicy</code> 为固定时间间隔。建议不要使用1，会造成重试过快；</li>
</ul>
</li>
<li><p><code>ExponentialRandomBackOffPolicy</code>：继承自 <code>ExponentialBackOffPolicy</code>，只是重写了获取重试时间间隔的方法。在获取重试间隔后，在加上一些随机的时间。</p>
</li>
</ul>
<h3 id="有状态重试、无状态重试"><a href="#有状态重试、无状态重试" class="headerlink" title="有状态重试、无状态重试"></a>有状态重试、无状态重试</h3><p>所谓<strong>无状态重试</strong>是指重试<strong>在一个线程上下文中完成</strong>的重试，反之<strong>不在一个线程上下文完成</strong>重试的就是<strong>有状态重试</strong>。 之前的 <code>SimpleRetryPolicy</code> 就属于无状态重试，因为重试是在一个循环中完成的。那么什么时候后会出现或者说需要有状态重试呢？通常有两种情况：<strong>事务回滚</strong>和<strong>熔断</strong>。</p>
<p>数据库操作异常 <code>DataAccessException</code>，不能执行重试，而如果抛出其他异常可以重试。</p>
<p>熔断的意思不在当前循环中处理重试，而是全局重试模式（不是线程上下文）。熔断会跳出循环，那么必然会丢失线程上下文的堆栈信息。 那么肯定需要一种“全局模式”保存这种信息，目前的实现放在一个 cache（map 实现的）中，下次从缓存中获取就能继续重试了。</p>
<p><strong>eg：</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.retry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-retry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"> * <span class="meta">@author</span> vincent</span><br><span class="line"> */</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringRetry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line">     * 调取上海当前天气的情况</span><br><span class="line">     *</span><br><span class="line">     * <span class="meta">@return</span></span><br><span class="line">     */</span><br><span class="line">    <span class="function"><span class="keyword">public</span> WeatherInfo <span class="title">getWeather</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//上海区域编码</span></span><br><span class="line">        String AreaCode = <span class="string">&quot;101020100&quot;</span>;</span><br><span class="line">        String url = <span class="string">&quot;http://www.weather.com.cn/data/sk/&quot;</span> + AreaCode + <span class="string">&quot;.html&quot;</span>;</span><br><span class="line">        String json = HttpUtil.get(url, CharsetUtil.CHARSET_UTF_8);</span><br><span class="line">        JSON parse = JSONUtil.parse(json);</span><br><span class="line">        WeatherInfo weatherinfo = parse.getByPath(<span class="string">&quot;weatherinfo&quot;</span>, WeatherInfo.class);</span><br><span class="line">        <span class="keyword">return</span> weatherinfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line">     * <span class="meta">@throws</span> Throwable</span><br><span class="line">     */</span><br><span class="line">    <span class="function"><span class="keyword">public</span> WeatherInfo <span class="title">retryDoSomething</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 构建重试模板实例</span></span><br><span class="line">        RetryTemplate retryTemplate = <span class="keyword">new</span> RetryTemplate();</span><br><span class="line">        <span class="comment">// 设置重试策略，主要设置重试次数</span></span><br><span class="line">        SimpleRetryPolicy policy = <span class="keyword">new</span> SimpleRetryPolicy(<span class="number">3</span>, Collections.singletonMap(Exception.class, <span class="keyword">true</span>));</span><br><span class="line">        <span class="comment">// 设置重试回退操作策略，主要设置重试间隔时间</span></span><br><span class="line">        FixedBackOffPolicy fixedBackOffPolicy = <span class="keyword">new</span> FixedBackOffPolicy();</span><br><span class="line">        fixedBackOffPolicy.setBackOffPeriod(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        retryTemplate.setRetryPolicy(policy);</span><br><span class="line">        retryTemplate.setBackOffPolicy(fixedBackOffPolicy);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;开始调取外部接口......&quot;</span>);</span><br><span class="line">        WeatherInfo execute = retryTemplate.execute(<span class="keyword">new</span> RetryCallback&lt;WeatherInfo, Throwable&gt;() &#123;</span><br><span class="line">            <span class="comment">// 通过RetryCallback 重试回调实例包装正常逻辑逻辑，第一次执行和重试执行执行的都是这段逻辑</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> WeatherInfo <span class="title">doWithRetry</span><span class="params">(RetryContext retryContext)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="comment">//RetryContext 重试操作上下文约定，统一 spring-try 包装</span></span><br><span class="line"></span><br><span class="line">                log.debug(<span class="string">&quot;第 &#123;&#125; 次重试.....&quot;</span>, retryContext.getRetryCount());</span><br><span class="line">                WeatherInfo weather = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    weather = getWeather();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//模拟调取外部接口时发生异常</span></span><br><span class="line">                    <span class="keyword">int</span> a = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line">                    log.error(<span class="string">&quot;捕获到的异常&#123;&#125;......&quot;</span>,e.getMessage());</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();<span class="comment">//这个点特别注意，重试的根源通过 Exception 返回</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> weather;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> RecoveryCallback&lt;WeatherInfo&gt;() &#123;</span><br><span class="line">            <span class="comment">// 通过 RecoveryCallback 重试流程正常结束或者达到重试上限后的退出恢复操作实例</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> WeatherInfo <span class="title">recover</span><span class="params">(RetryContext retryContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                log.info(<span class="string">&quot;do recory operation...&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        log.debug(<span class="string">&quot;调取外部接口结束......&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> execute;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">t2</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        WeatherInfo weatherInfo = retryDoSomething();</span><br><span class="line">        log.info(<span class="string">&quot;调用返回的天气情况&#123;&#125;!!!&quot;</span>, weatherInfo);</span><br><span class="line">        log.info(<span class="string">&quot;go on with something...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherInfo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line">     * city : 上海</span><br><span class="line">     * cityid : <span class="number">101190408</span></span><br><span class="line">     * temp : <span class="number">23.5</span></span><br><span class="line">     * WD : 东北风</span><br><span class="line">     * WS : 小于<span class="number">3</span>级</span><br><span class="line">     * SD : <span class="number">80</span>%</span><br><span class="line">     * AP : <span class="number">1006.</span>4hPa</span><br><span class="line">     * njd : <span class="number">2903</span></span><br><span class="line">     * WSE : &lt;<span class="number">3</span></span><br><span class="line">     * time : <span class="number">17</span>:<span class="number">00</span></span><br><span class="line">     * sm : <span class="number">1.1</span></span><br><span class="line">     * isRadar : <span class="number">1</span></span><br><span class="line">     * Radar : JC_RADAR_AZ9210_JB)!!!</span><br><span class="line">     */</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String cityid;</span><br><span class="line">    <span class="keyword">private</span> String temp;</span><br><span class="line">    <span class="keyword">private</span> String WD;</span><br><span class="line">    <span class="keyword">private</span> String WS;</span><br><span class="line">    <span class="keyword">private</span> String SD;</span><br><span class="line">    <span class="keyword">private</span> String AP;</span><br><span class="line">    <span class="keyword">private</span> String njd;</span><br><span class="line">    <span class="keyword">private</span> String WSE;</span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line">    <span class="keyword">private</span> String sm;</span><br><span class="line">    <span class="keyword">private</span> String isRadar;</span><br><span class="line">    <span class="keyword">private</span> String Radar;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果为：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.575</span> <span class="selector-attr">[main]</span> DEBUG com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 开始调取外部接口......</span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.583</span> <span class="selector-attr">[main]</span> DEBUG org<span class="selector-class">.springframework</span><span class="selector-class">.retry</span><span class="selector-class">.support</span><span class="selector-class">.RetryTemplate</span> - Retry: count=<span class="number">0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.583</span> <span class="selector-attr">[main]</span> DEBUG com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 第 <span class="number">0</span> 次重试.....</span><br><span class="line">四月 <span class="number">29</span>, <span class="number">2020</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">57</span> 下午 java<span class="selector-class">.net</span><span class="selector-class">.CookieManager</span> put</span><br><span class="line">SEVERE: Invalid cookie <span class="keyword">for</span> http:<span class="comment">//www.weather.com.cn/data/sk/101020100.html: HttpOnly</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.754</span> <span class="selector-attr">[main]</span> ERROR com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 捕获到的异常/ by zero......</span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.858</span> <span class="selector-attr">[main]</span> DEBUG org<span class="selector-class">.springframework</span><span class="selector-class">.retry</span><span class="selector-class">.support</span><span class="selector-class">.RetryTemplate</span> - Checking <span class="keyword">for</span> rethrow: count=<span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.858</span> <span class="selector-attr">[main]</span> DEBUG org<span class="selector-class">.springframework</span><span class="selector-class">.retry</span><span class="selector-class">.support</span><span class="selector-class">.RetryTemplate</span> - Retry: count=<span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.858</span> <span class="selector-attr">[main]</span> DEBUG com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 第 <span class="number">1</span> 次重试.....</span><br><span class="line">四月 <span class="number">29</span>, <span class="number">2020</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">57</span> 下午 java<span class="selector-class">.net</span><span class="selector-class">.CookieManager</span> put</span><br><span class="line">SEVERE: Invalid cookie <span class="keyword">for</span> http:<span class="comment">//www.weather.com.cn/data/sk/101020100.html: HttpOnly</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.875</span> <span class="selector-attr">[main]</span> ERROR com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 捕获到的异常/ by zero......</span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.980</span> <span class="selector-attr">[main]</span> DEBUG org<span class="selector-class">.springframework</span><span class="selector-class">.retry</span><span class="selector-class">.support</span><span class="selector-class">.RetryTemplate</span> - Checking <span class="keyword">for</span> rethrow: count=<span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.980</span> <span class="selector-attr">[main]</span> DEBUG org<span class="selector-class">.springframework</span><span class="selector-class">.retry</span><span class="selector-class">.support</span><span class="selector-class">.RetryTemplate</span> - Retry: count=<span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.980</span> <span class="selector-attr">[main]</span> DEBUG com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 第 <span class="number">2</span> 次重试.....</span><br><span class="line">四月 <span class="number">29</span>, <span class="number">2020</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">57</span> 下午 java<span class="selector-class">.net</span><span class="selector-class">.CookieManager</span> put</span><br><span class="line">SEVERE: Invalid cookie <span class="keyword">for</span> http:<span class="comment">//www.weather.com.cn/data/sk/101020100.html: HttpOnly</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.994</span> <span class="selector-attr">[main]</span> ERROR com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 捕获到的异常/ by zero......</span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.994</span> <span class="selector-attr">[main]</span> DEBUG org<span class="selector-class">.springframework</span><span class="selector-class">.retry</span><span class="selector-class">.support</span><span class="selector-class">.RetryTemplate</span> - Checking <span class="keyword">for</span> rethrow: count=<span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.994</span> <span class="selector-attr">[main]</span> DEBUG org<span class="selector-class">.springframework</span><span class="selector-class">.retry</span><span class="selector-class">.support</span><span class="selector-class">.RetryTemplate</span> - Retry failed last attempt: count=<span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.994</span> <span class="selector-attr">[main]</span> INFO com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - do recory operation...</span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.994</span> <span class="selector-attr">[main]</span> DEBUG com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 调取外部接口结束......</span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.994</span> <span class="selector-attr">[main]</span> INFO com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 调用返回的天气情况 null!!!</span><br><span class="line"><span class="number">23</span>:<span class="number">49</span>:<span class="number">57.994</span> <span class="selector-attr">[main]</span> INFO com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - go on with something......</span><br></pre></td></tr></table></figure></p>
<p>屏蔽 <code>int a = 1 / 0;</code> 后，请求正常的结果：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">24.342</span> <span class="selector-attr">[main]</span> DEBUG com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 开始调取外部接口......</span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">24.350</span> <span class="selector-attr">[main]</span> DEBUG org<span class="selector-class">.springframework</span><span class="selector-class">.retry</span><span class="selector-class">.support</span><span class="selector-class">.RetryTemplate</span> - Retry: count=<span class="number">0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">24.350</span> <span class="selector-attr">[main]</span> DEBUG com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 第 <span class="number">0</span> 次重试.....</span><br><span class="line">四月 <span class="number">29</span>, <span class="number">2020</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">24</span> 下午 java<span class="selector-class">.net</span><span class="selector-class">.CookieManager</span> put</span><br><span class="line">SEVERE: Invalid cookie <span class="keyword">for</span> http:<span class="comment">//www.weather.com.cn/data/sk/101020100.html: HttpOnly</span></span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">24.527</span> <span class="selector-attr">[main]</span> DEBUG com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 调取外部接口结束......</span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">24.527</span> <span class="selector-attr">[main]</span> INFO com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - 调用返回的天气情况 WeatherInfo(city=上海, cityid=<span class="number">101020100</span>, temp=<span class="number">23.5</span>, WD=东北风, WS=小于<span class="number">3</span>级, SD=<span class="number">80%</span>, AP=<span class="number">1006.4</span>hPa, njd=<span class="number">2903</span>, WSE=&lt;<span class="number">3</span>, time=<span class="number">17</span>:<span class="number">00</span>, sm=<span class="number">1.1</span>, isRadar=<span class="number">1</span>, Radar=JC_RADAR_AZ9210_JB)!!!</span><br><span class="line"><span class="number">23</span>:<span class="number">51</span>:<span class="number">24.527</span> <span class="selector-attr">[main]</span> INFO com<span class="selector-class">.example</span><span class="selector-class">.retrymechanism</span><span class="selector-class">.spring_retry</span><span class="selector-class">.SpringRetry</span> - go on with something......</span><br></pre></td></tr></table></figure>
<h2 id="声明式（基于注解）"><a href="#声明式（基于注解）" class="headerlink" title="声明式（基于注解）"></a>声明式（基于注解）</h2><p>最后我们了解下如何使用注解实现重试机制。最基本的，我们需要以下这几个注解：</p>
<ul>
<li><p><code>@EnableRetry</code>：能否重试。注解类的，其 <code>proxyTargetClass</code> 属性为 <code>true</code> 时，使用 <code>CGLIB</code> 代理。默认使用标准 JAVA 注解。当类中有 <code>@Retryable</code> 注释的方法时，对该方法生成代理。</p>
</li>
<li><p><code>@Retryable</code>：注解需要被重试的方法。</p>
<ul>
<li><code>include</code> 指定处理的异常类，默认所有异常。</li>
<li><code>maxAttempts</code> 最大重试次数，默认3次。</li>
<li><code>backoff</code> 重试等待策略。默认使用 <code>@Backoff</code> 注解。</li>
</ul>
</li>
<li><p><code>@Backoff</code>：重试等待策略。</p>
<ul>
<li>不设置参数时，默认使用 <code>FixedBackOffPolicy</code> 重试等待1000ms。</li>
<li>只设置 <code>delay()</code> 属性时，使用 <code>FixedBackOffPolicy</code> 重试等待指定的毫秒数。</li>
<li>当设置 <code>delay()</code> 和 <code>maxDealy()</code> 属性时，重试等待在这两个值之间均态分布。</li>
<li>使用 <code>delay()</code>、<code>maxDealy()</code> 和 <code>multiplier()</code> 属性时，使用 <code>ExponentialBackOffPolicy</code>。</li>
<li>当设置 <code>multiplier()</code> 属性不等于0时，同时也设置了 <code>random()</code> 属性时，使用 <code>ExponentialRandomBackOffPolicy</code>。</li>
</ul>
</li>
<li><p><code>@Recover</code>：用于方法。用于 <code>@Retryable</code> 失败时的“兜底”处理方法。<code>@Recover</code> 注释的方法参数为 <code>@Retryable</code> 异常类，返回值应与重试方法返回相同，否则无法识别！因此可以针对可能异常设置多个 <code>@Recover</code> 方法进行“兜底”处理。</p>
</li>
</ul>
<p><strong>eg：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@EnableRetry()</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnoService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Logger logger = LoggerFactory.getLogger(AnnoService.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Retryable(maxAttempts = 5, backoff = @Backoff(random = true))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">someService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> random = (<span class="keyword">int</span>) (Math.random() * <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (random &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;random=&#123;&#125; Null Pointer Excep&quot;</span>, random);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (random &lt; <span class="number">9</span>) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;random=&#123;&#125; Arithmetic Excep&quot;</span>, random);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;random=&#123;&#125; ok !!!!&quot;</span>, random);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Recover</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">recover</span><span class="params">(NullPointerException ne)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="string">&quot;NullPointerException&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;null pointer recover&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Recover</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">recover</span><span class="params">(ArithmeticException ne)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="string">&quot;ArithmeticException&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ArithmeticException recover&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(<span class="string">&quot;com.leeyee.spring.retry.*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        AnnoService annoService = context.getBean(AnnoService.class);</span><br><span class="line">        String result = annoService.someService();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Source Code：<a target="_blank" rel="noopener" href="https://github.com/V-Vincen/retry-mechanism">https://github.com/V-Vincen/retry-mechanism</a></p>
<p>官网：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-retry">https://github.com/spring-projects/spring-retry</a><br>参考：<a target="_blank" rel="noopener" href="https://www.baeldung.com/spring-retry">https://www.baeldung.com/spring-retry</a></p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/Guava-Retrying-Guava-Retrying/" data-toggle="tooltip" data-placement="top" title="[Guava Retrying] Guava Retrying">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/Git-7-Git-Tag-And-Git-Branch/" data-toggle="tooltip" data-placement="top" title="[Git] 7 Git Tag And Git Branch">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=[Spring Retry] Spring Retry&body=Hi,I found this website and thought you might like it https://v-vincen.life/en/Spring-Retry-Spring-Retry/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <script src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: 'c5c071e55f689f41560d',
      clientSecret: '1e8aabf73ccb26e519ee937ea1ddd241c5d13b79',
      repo: 'blog-comment',
      owner: 'V-Vincen',
      admin: 'V-Vincen',
      id: 'Thu Apr 30 2020 01:55:06 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://www.v-vincen.icu/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">概述</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%B1%BB%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">类结构说明</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">核心功能</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#RetryOperations-%E6%8E%A5%E5%8F%A3"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">RetryOperations 接口</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#RetryCallback-%E6%8E%A5%E5%8F%A3"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">RetryCallback 接口</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%87%8D%E8%AF%95%E7%AD%96%E7%95%A5"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">重试策略</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%87%8D%E8%AF%95%E5%9B%9E%E9%80%80%E7%AD%96%E7%95%A5"><span class="toc-nav-number">3.4.</span> <span class="toc-nav-text">重试回退策略</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%9C%89%E7%8A%B6%E6%80%81%E9%87%8D%E8%AF%95%E3%80%81%E6%97%A0%E7%8A%B6%E6%80%81%E9%87%8D%E8%AF%95"><span class="toc-nav-number">3.5.</span> <span class="toc-nav-text">有状态重试、无状态重试</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%EF%BC%88%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%EF%BC%89"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">声明式（基于注解）</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Spring Retry" title="Spring Retry">Spring Retry</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="http://teacherye.com/" target="_blank">Teacher Ye</a>
          </li>
          
          <li>
            <a href="https://goldenaarcher.github.io/" target="_blank">GoldenaArcher</a>
          </li>
          
          <li>
            <a href="https://www.cnblogs.com/guoyinghome/" target="_blank">鸢羽_颖</a>
          </li>
          
          <li>
            <a href="https://cungudafa.top" target="_blank">cungudafa</a>
          </li>
          
          <li>
            <a href="https://www.hm1006.cn" target="_blank">hmblog</a>
          </li>
          
          <li>
            <a href="https://yremp.live" target="_blank">Yremp</a>
          </li>
          
          <li>
            <a href="https://vuial.cn" target="_blank">Vuial</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/V-Vincen">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://twitter.com/V_Vincen_">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://www.instagram.com/v_vincen_">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          
            <li>
              <a target="_blank" href="http://weibo.com/WVincen">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Mr.Vincent
          2021
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/jquery.min.js"></script>

  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/bootstrap.min.js"></script>

  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/hux-blog.min.js"></script>

  <!-- catalog -->
  <script async="true" type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/catalog.js"></script>

  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/mouseclick.js"  content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033' ></script>
    <!-- Mouseclick -->
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/ribbonDynamic.js"></script>
  

  




  <!-- CDN: jsdelivr start -->
  <script async="async" type="text/javascript">
    let imgsUrl = document.getElementsByTagName("img");
    let imgUrl = Array.from(imgsUrl);

    let jsdelivr = "https://cdn.jsdelivr.net/gh/";
    let gh = "V-Vincen";
    let ghPages = gh + ".github.io";
    let pagePath = "en/Spring-Retry-Spring-Retry/";
    let jsdelivrurl;
    if (pagePath.indexOf("index.html") != -1) {
      jsdelivrurl = jsdelivr + gh + "/" + ghPages;
    } else {
      jsdelivrurl = jsdelivr + gh + "/" + ghPages + "/" + pagePath;
    }
    imgUrl.forEach(item => {
      let oldUrl = item.getAttribute("src");
      let newUrl = oldUrl.replace(oldUrl, jsdelivrurl + oldUrl).replace("..", "");
      item.setAttribute("src", newUrl);
    });
  </script>
  <!-- CDN: jsdelivr end -->



  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://v-vincen.life/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            
              imgUrl = 'https://cdn.jsdelivr.net/gh/V-Vincen/V-Vincen.github.io' + imgUrl;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
</html>
